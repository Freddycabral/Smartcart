<!doctype html>
<html lang="pt-BR" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Smart Cart - Organize suas compras de forma inteligente">
  <meta name="theme-color" content="#6366f1">
  <title>Smart Cart - Lista de Compras</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800;900&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
    }
    
    * {
      font-family: 'Outfit', sans-serif;
    }

    .slide-in {
      animation: slideIn 0.3s ease-out forwards;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in {
      animation: fadeIn 0.4s ease-out forwards;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .item-enter {
      animation: itemEnter 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes itemEnter {
      from {
        opacity: 0;
        transform: scale(0.95) translateY(10px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .loading-spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      width: 24px;
      height: 24px;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 16px 24px;
      border-radius: 12px;
      color: white;
      font-weight: 600;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      z-index: 1000;
      animation: toastIn 0.3s ease-out;
    }

    @keyframes toastIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .toast.success {
      background: linear-gradient(135deg, #10b981, #059669);
    }

    .toast.error {
      background: linear-gradient(135deg, #ef4444, #dc2626);
    }

    .toast.info {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
    }

    .modal-overlay {
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(4px);
    }

    .modal-content {
      animation: modalIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes modalIn {
      from {
        opacity: 0;
        transform: scale(0.95) translateY(20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    /* --- ESTILO NOVO DO MICROFONE --- */
    .mic-recording {
      background: linear-gradient(135deg, #ef4444, #dc2626) !important;
      color: white !important;
      animation: pulse-red 1.5s infinite;
      border-color: #ef4444 !important;
    }

    @keyframes pulse-red {
      0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
      100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }
    /* ------------------------------ */

    input[type="checkbox"]:checked {
      background: linear-gradient(135deg, #10b981, #059669);
    }

    .category-badge {
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 20px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-card {
      background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08));
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.2);
    }

    .section-header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.95), rgba(139, 92, 246, 0.95));
      backdrop-filter: blur(12px);
      border-left: 4px solid #fbbf24;
      transition: all 0.3s ease;
    }

    .section-header:hover {
      background: linear-gradient(135deg, rgba(99, 102, 241, 1), rgba(139, 92, 246, 1));
      transform: translateX(4px);
    }

    .section-container {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 16px;
      border-radius: 16px;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .section-container:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .add-section-btn {
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2));
      border: 2px dashed rgba(251, 191, 36, 0.5);
      transition: all 0.3s ease;
    }

    .add-section-btn:hover {
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.3), rgba(245, 158, 11, 0.3));
      border-color: rgba(251, 191, 36, 0.8);
      transform: scale(1.02);
    }
    
    .clear-list-btn {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.1));
      border: 2px dashed rgba(239, 68, 68, 0.4);
      transition: all 0.3s ease;
    }
    
    .clear-list-btn:hover {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.2));
      border-color: rgba(239, 68, 68, 0.7);
      transform: scale(1.02);
    }

    .search-highlight {
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.3), rgba(245, 158, 11, 0.3));
      border: 2px solid rgba(251, 191, 36, 0.8);
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 overflow-auto">
  <div class="min-h-full w-full p-4 md:p-6"><header class="max-w-4xl mx-auto mb-6">
    <div class="text-center mb-6">
     <h1 id="app-title" class="text-4xl md:text-5xl font-black text-white mb-2">Smart Cart</h1>
     <p id="footer-text" class="text-white/90 font-medium">Organize suas compras de forma inteligente</p>
    </div><div class="grid grid-cols-3 gap-3 mb-6">
     <div class="stat-card rounded-xl p-4 text-center">
      <div id="total-items" class="text-2xl font-black text-white">
       0
      </div>
      <div class="text-white/80 text-xs font-semibold uppercase tracking-wide">
       Itens
      </div>
     </div>
     <div class="stat-card rounded-xl p-4 text-center overflow-hidden">
      <div id="total-price" class="text-lg sm:text-xl font-black text-green-300 break-words">
       R$ 0
      </div>
      <div class="text-white/80 text-xs font-semibold uppercase tracking-wide">
       Total
      </div>
     </div>
     <div class="stat-card rounded-xl p-4 text-center">
      <div id="checked-items" class="text-2xl font-black text-yellow-300">
       0
      </div>
      <div class="text-white/80 text-xs font-semibold uppercase tracking-wide">
       Comprados
      </div>
     </div>
    </div><div class="mb-4 relative"><span class="absolute left-4 top-1/2 -translate-y-1/2 text-2xl">üîç</span> <input type="text" id="search-input" placeholder="üîç Pesquisar produtos..." class="w-full pl-14 pr-6 py-4 bg-white/95 backdrop-blur-lg rounded-xl border-2 border-white/30 focus:border-yellow-300 focus:outline-none transition-all shadow-lg font-semibold text-gray-700 placeholder-gray-400"> <button id="clear-search-btn" onclick="clearSearch()" class="absolute right-3 top-1/2 -translate-y-1/2 bg-red-500 hover:bg-red-600 text-white rounded-full p-2 transition-all hidden">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg></button>
    </div><div class="flex gap-3"><button id="ai-btn" onclick="openAIModal()" class="flex-1 bg-gradient-to-r from-purple-500 via-indigo-500 to-blue-500 hover:from-purple-600 hover:via-indigo-600 hover:to-blue-600 text-white font-bold py-4 px-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-1 flex items-center justify-center gap-2"> <span class="text-2xl">ü§ñ</span> <span id="ai-button-text">Adicionar com IA</span> </button> <button onclick="openAddModal()" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-1 flex items-center justify-center gap-2"> <span class="text-2xl">‚ûï</span> <span id="add-button-text">Adicionar Item</span> </button>
    </div>
   </header><main class="max-w-4xl mx-auto mb-24 min-h-[60vh]">
    <div class="flex flex-col sm:flex-row gap-3 mb-4">
      <button type="button" onclick="event.preventDefault(); openAddSectionModal();" class="flex-1 add-section-btn rounded-xl p-4 font-bold text-yellow-300 hover:text-yellow-200 transition-all flex items-center justify-center gap-2"> <span class="text-2xl">üìÅ</span> <span>Gerenciar Categorias</span> </button>
      <button type="button" onclick="openClearAllModal()" class="flex-1 clear-list-btn rounded-xl p-4 font-bold text-red-400 hover:text-red-300 transition-all flex items-center justify-center gap-2"> <span class="text-2xl">üóëÔ∏è</span> <span>Esvaziar Lista</span> </button>
    </div>
    
    <div id="sections-container" class="space-y-4"></div><div id="empty-state" class="text-center py-24">
     <div class="text-8xl mb-4">
      üõí
     </div>
     <h3 class="text-2xl font-bold text-white mb-2">Sua lista est√° vazia</h3>
     <p class="text-white/80">Adicione seu primeiro item!</p>
    </div>
   </main>
  </div><footer class="w-full py-3 mt-48">
   <div class="max-w-4xl mx-auto px-4">
    <div class="text-center"><button onclick="togglePrivacy()" class="text-gray-900 hover:text-gray-700 text-sm font-semibold underline transition-colors"> Pol√≠tica de Privacidade </button>
    </div>
   </div>
  </footer><div id="privacy-modal" class="fixed inset-0 modal-overlay hidden items-center justify-center z-50" onclick="closePrivacyModal(event)">
   <div class="modal-content bg-white rounded-2xl p-6 max-w-2xl w-full mx-4 max-h-[90%] overflow-y-auto" onclick="event.stopPropagation()">
    <div class="flex items-start justify-between mb-4">
     <h3 class="text-2xl font-bold text-gray-800 flex items-center gap-2"><span>üîí</span> Pol√≠tica de Privacidade</h3><button onclick="closePrivacyModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg></button>
    </div>
    <div class="space-y-4 text-sm text-gray-700">
     <p class="text-xs text-gray-500"><strong>√öltima atualiza√ß√£o:</strong> Janeiro de 2025</p>
     <div class="border-l-4 border-indigo-500 pl-4">
      <h4 class="font-bold text-gray-800 mb-2">üì¶ Dados Armazenados</h4>
      <p>Salvamos localmente no seu dispositivo: lista de compras (produtos, pre√ßos, quantidades) e categorias personalizadas. Todos os dados ficam armazenados apenas no navegador do seu dispositivo.</p>
     </div>
     <div class="border-l-4 border-green-500 pl-4">
      <h4 class="font-bold text-gray-800 mb-2">üïµÔ∏è‚Äç‚ôÇÔ∏è Privacidade Total</h4>
      <p>Todos os dados ficam apenas no seu celular/computador atrav√©s do armazenamento local do navegador (localStorage). <strong>N√ÉO</strong> enviamos absolutamente nada para servidores externos (exceto quando voc√™ usa a fun√ß√£o IA, que envia temporariamente para processamento e n√£o armazena). <strong>N√ÉO</strong> coletamos informa√ß√µes pessoais. <strong>N√ÉO</strong> compartilhamos seus dados com terceiros.</p>
     </div>
     <div class="border-l-4 border-yellow-500 pl-4">
      <h4 class="font-bold text-gray-800 mb-2">üóëÔ∏è Controle Total dos Seus Dados</h4>
      <p>Voc√™ pode deletar todos os dados a qualquer momento de tr√™s formas: 1) Desinstalando o aplicativo; 2) Limpando o cache e dados do navegador; 3) Deletando manualmente cada item dentro do app ou usando o bot√£o "Esvaziar Lista".</p>
     </div>
     <div class="border-l-4 border-blue-500 pl-4">
      <h4 class="font-bold text-gray-800 mb-2">ü§ñ Uso da Intelig√™ncia Artificial (Opcional)</h4>
      <p>Se voc√™ optar por usar a funcionalidade de IA, o texto ou imagem √© enviado de forma segura para processamento e descartado em seguida.</p>
     </div>
     <button onclick="closePrivacyModal()" class="mt-6 w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl transition-colors"> Entendi </button>
    </div>
   </div>
  </div><div id="add-modal" class="fixed inset-0 modal-overlay hidden items-center justify-center z-50" onclick="closeAddModal(event)">
   <div class="modal-content bg-white rounded-2xl p-6 max-w-md w-full mx-4" onclick="event.stopPropagation()">
    <h2 id="add-modal-title" class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2"><span class="text-3xl">üìå</span> Adicionar Item</h2>
    <form id="add-form" onsubmit="handleAddItem(event)">
     <input type="hidden" id="edit-item-id" value="">
     <div class="space-y-4">
      <div><label for="item-name" class="block text-sm font-semibold text-gray-700 mb-2">Nome do Produto</label> <input type="text" id="item-name" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-indigo-500 transition-colors" placeholder="Ex: Arroz, Feij√£o, Leite...">
      </div>
      <div class="grid grid-cols-2 gap-3">
       <div><label for="item-price" class="block text-sm font-semibold text-gray-700 mb-2">Pre√ßo (R$)</label> <input type="text" inputmode="numeric" pattern="[0-9.,]*" id="item-price" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-indigo-500 transition-colors" placeholder="0,00" oninput="formatPrice(this)">
       </div>
       <div><label for="item-quantity" class="block text-sm font-semibold text-gray-700 mb-2">Quantidade</label> <input type="number" id="item-quantity" min="1" value="1" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-indigo-500 transition-colors">
       </div>
      </div>
      <div><label for="item-category" class="block text-sm font-semibold text-gray-700 mb-2">Categoria</label> <select id="item-category" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-indigo-500 transition-colors"> </select>
      </div>
     </div>
     <div class="flex gap-3 mt-6"><button type="button" onclick="closeAddModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-6 rounded-xl transition-colors"> Cancelar </button> <button type="submit" id="add-submit-btn" class="flex-1 bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 text-white font-bold py-3 px-6 rounded-xl transition-all"> Adicionar </button>
     </div>
    </form>
   </div>
  </div><div id="add-section-modal" class="fixed inset-0 modal-overlay hidden items-center justify-center z-50" onclick="closeAddSectionModal(event)">
   <div class="modal-content bg-white rounded-2xl p-6 max-w-lg w-full mx-4 max-h-[90%] overflow-y-auto" onclick="event.stopPropagation()">
    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2"><span class="text-3xl">üìÅ</span> Gerenciar Categorias</h2><div class="mb-6">
     <h3 class="text-sm font-semibold text-gray-700 mb-3">Suas Categorias Personalizadas:</h3>
     <div id="custom-sections-list" class="space-y-2 mb-4"></div>
    </div><form id="add-section-form" onsubmit="handleAddSection(event)">
     <div class="mb-4"><label for="section-name" class="block text-sm font-semibold text-gray-700 mb-2">Adicionar Nova Categoria</label> <input type="text" id="section-name" required maxlength="30" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-indigo-500 transition-colors" placeholder="Ex: ü•ñ Padaria, ü•© A√ßougue, ü•¶ Feira...">
      <p class="text-xs text-gray-500 mt-2">üí° Dica: Comece com um emoji para deixar mais visual!</p>
     </div>
     <div class="flex gap-3"><button type="button" onclick="closeAddSectionModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-6 rounded-xl transition-colors"> Fechar </button> <button type="submit" class="flex-1 bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 text-white font-bold py-3 px-6 rounded-xl transition-all"> Adicionar </button>
     </div>
    </form>
   </div>
  </div><div id="delete-modal" class="fixed inset-0 modal-overlay hidden items-center justify-center z-50" onclick="closeDeleteModal(event)">
   <div class="modal-content bg-white rounded-2xl p-6 max-w-sm w-full mx-4" onclick="event.stopPropagation()">
    <div class="text-center mb-4">
     <div class="text-6xl mb-3">
      üóëÔ∏è
     </div>
     <h3 class="text-xl font-bold text-gray-800 mb-2">Remover Item?</h3>
     <p class="text-gray-600">Tem certeza que deseja remover este item da lista?</p>
    </div>
    <div class="flex gap-3"><button onclick="closeDeleteModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-6 rounded-xl transition-colors"> Cancelar </button> <button id="confirm-delete-btn" onclick="confirmDelete()" class="flex-1 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold py-3 px-6 rounded-xl transition-all"> Remover </button>
    </div>
   </div>
  </div>
  
  <div id="clear-all-modal" class="fixed inset-0 modal-overlay hidden items-center justify-center z-50" onclick="closeClearAllModal(event)">
   <div class="modal-content bg-white rounded-2xl p-6 max-w-sm w-full mx-4" onclick="event.stopPropagation()">
    <div class="text-center mb-4">
     <div class="text-6xl mb-3">‚ö†Ô∏è</div>
     <h3 class="text-xl font-bold text-gray-800 mb-2">Esvaziar Lista?</h3>
     <p class="text-gray-600">Isso remover√° <b>todos</b> os itens da sua lista permanentemente.</p>
    </div>
    <div class="flex gap-3">
        <button onclick="closeClearAllModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-6 rounded-xl transition-colors"> Cancelar </button> 
        <button onclick="confirmClearAll()" class="flex-1 bg-gradient-to-r from-red-500 to-red-600 text-white font-bold py-3 px-6 rounded-xl transition-all"> Sim, Apagar </button>
    </div>
   </div>
  </div>

  <div id="ai-modal" class="fixed inset-0 modal-overlay hidden items-center justify-center z-50 p-4 overflow-y-auto" onclick="closeAIModal(event)">
   <div class="modal-content bg-white rounded-3xl p-4 md:p-8 max-w-lg w-full mx-auto my-8 shadow-2xl max-h-[95vh] overflow-y-auto" onclick="event.stopPropagation()">
    
    <div class="flex items-center justify-between mb-6">
     <h2 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-indigo-600 flex items-center gap-3"><span class="text-4xl">ü§ñ</span> <span>Assistente IA</span></h2>
     <button onclick="closeAIModal()" class="text-gray-400 hover:text-gray-600 transition-colors p-2 hover:bg-gray-100 rounded-full">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
     </button>
    </div>

    <div class="bg-gradient-to-r from-purple-50 to-indigo-50 border-l-4 border-purple-500 rounded-lg p-3 md:p-4 mb-4 md:mb-6">
     <p class="text-sm text-gray-700 font-bold mb-2 md:mb-3 flex items-center gap-2"><span class="text-lg">‚ú®</span> Como funciona:</p>
     <ul class="text-xs md:text-sm text-gray-700 space-y-2 ml-1">
      <li class="flex items-start gap-2"><span class="text-lg flex-shrink-0">üé§Ô∏è</span> <span><strong>Falar:</strong> Use o microfone no campo de texto para ditar itens</span></li>
      <li class="flex items-start gap-2"><span class="text-lg flex-shrink-0">üì∏</span> <span><strong>C√¢mera:</strong> Tire foto da lista ou produtos.</span></li>
     </ul>
    </div>

    <div class="grid grid-cols-2 gap-2 md:gap-3 mb-4 md:mb-6">
      <button type="button" onclick="showTextInput()" class="bg-gradient-to-br from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white font-bold py-4 rounded-2xl shadow-lg hover:shadow-xl transition-all hover:-translate-y-1 flex flex-col items-center gap-2"> 
        <span class="text-3xl md:text-4xl">‚úçÔ∏è</span> <span class="text-xs md:text-sm">Digitar</span> 
      </button> 

      <button type="button" onclick="showCameraInput()" class="bg-gradient-to-br from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-4 rounded-2xl shadow-lg hover:shadow-xl transition-all hover:-translate-y-1 flex flex-col items-center gap-2"> 
        <span class="text-3xl md:text-4xl">üì∏</span> <span class="text-xs md:text-sm">C√¢mera</span> 
      </button>
    </div>

    <div id="text-input-section" class="hidden relative">
      <label for="ai-text-input" class="block text-sm font-bold text-gray-700 mb-2">Digite ou use o microfone:</label>
      <div class="relative">
        <textarea id="ai-text-input" rows="8" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all text-gray-700 resize-none mb-4" placeholder="Ex: arroz, feij√£o, 2L de leite..."></textarea>
        
        <button id="mic-toggle-btn" onclick="toggleRecording()" class="absolute bottom-6 right-4 bg-gray-100 hover:bg-gray-200 text-gray-600 p-3 rounded-full transition-all shadow-sm border border-gray-300" title="Ativar microfone">
          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd" /></svg>
        </button>
      </div>
      
      <p id="mic-status" class="text-xs text-red-500 font-bold mb-2 hidden animate-pulse">üé§ Ouvindo... (Fale os itens)</p>

      <button type="button" id="text-submit-btn" onclick="handleAISubmit()" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-bold py-4 px-6 rounded-xl transition-all shadow-lg hover:shadow-xl flex items-center justify-center gap-2"> 
        <span class="text-xl">‚ú®</span> <span>Processar com IA</span> 
      </button>
    </div>

    <div id="camera-input-section" class="hidden">
      <label class="block text-sm font-bold text-gray-700 mb-2">Tire uma foto dos produtos com pre√ßos:</label> 
      <div class="relative bg-gradient-to-br from-gray-900 to-gray-800 rounded-xl overflow-hidden shadow-inner mb-4" style="height: 280px;">
        <video id="camera-stream" autoplay playsinline class="w-full h-full object-cover hidden"></video>
        <canvas id="photo-canvas" class="hidden"></canvas>
        <div id="captured-photo-preview" class="hidden w-full h-full"><img id="captured-photo-img" src="" alt="Foto capturada" class="w-full h-full object-cover"></div>
        <div id="start-camera-btn" class="absolute inset-0 flex flex-col items-center justify-center p-4">
          <button type="button" onclick="startCamera()" class="bg-white hover:bg-green-50 text-green-600 font-bold py-4 md:py-5 px-6 md:px-10 rounded-2xl transition-all shadow-xl hover:shadow-2xl hover:scale-105 flex items-center gap-2 md:gap-3"> 
            <span class="text-3xl md:text-4xl">üì∑</span> <span class="text-lg md:text-xl">Abrir C√¢mera</span> 
          </button>
        </div>
      </div>
      <div id="camera-controls" class="flex gap-2 mb-3 md:mb-4 hidden">
        <button type="button" onclick="capturePhoto()" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-3 px-3 md:px-4 rounded-xl transition-all shadow-lg hover:shadow-xl text-sm md:text-base"> üì∏ Capturar </button> 
        <button type="button" onclick="stopCamera()" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-3 md:px-4 rounded-xl transition-all shadow-lg hover:shadow-xl text-sm md:text-base"> ‚ùå Fechar </button>
      </div>
      <div id="photo-actions" class="space-y-2 hidden">
        <button type="button" id="camera-submit-btn" onclick="handleAISubmit()" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-bold py-3 md:py-4 px-4 md:px-6 rounded-xl transition-all shadow-lg hover:shadow-xl flex items-center justify-center gap-2 text-sm md:text-base"> <span class="text-lg md:text-xl">‚ú®</span> <span>Processar com IA</span> </button>
        <div class="flex gap-2"><button type="button" onclick="retakePhoto()" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2.5 md:py-3 px-3 md:px-4 rounded-xl transition-all text-sm md:text-base"> üîÑ Nova Foto </button> <button type="button" onclick="clearPhoto()" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2.5 md:py-3 px-3 md:px-4 rounded-xl transition-all text-sm md:text-base"> üóëÔ∏è Remover </button></div>
      </div>
    </div>
   </div>
  </div>
  
  <script>
    // ===================== PRODUCAO SAFE =====================
    const EMOJI_BOX = '\u{1F4E6}';
    const EMOJI_CART = '\u{1F6D2}';
    const EMOJI_ROBOT = '\u{1F916}';
    const EMOJI_SUCCESS = '\u2705';
    const EMOJI_ERROR = '\u274C';

    // ========================================================

    const STORAGE_KEY = 'smartcart_items';
    const SECTIONS_KEY = 'smartcart_sections';
    
    let items = [];
    let itemToDelete = null;
    let searchTerm = '';
    
    let customSections = [
      { id: 'alimentos', name: 'üçé Alimentos', isDefault: true },
      { id: 'bebidas', name: 'üßÉ Bebidas', isDefault: true },
      { id: 'higiene', name: 'üßº Higiene', isDefault: true },
      { id: 'limpeza', name: 'üßπ Limpeza', isDefault: true },
      { id: 'outros', name: 'üì¶ Outros', isDefault: true }
    ];

    function loadFromStorage() {
      try {
        const savedItems = localStorage.getItem(STORAGE_KEY);
        if (savedItems) {
          items = JSON.parse(savedItems);
        }
        
        const savedSections = localStorage.getItem(SECTIONS_KEY);
        if (savedSections) {
          const parsed = JSON.parse(savedSections);
          const userSections = parsed.filter(s => !s.isDefault);
          customSections = [...customSections.filter(s => s.isDefault), ...userSections];
        }
      } catch (e) {
        console.error('Erro ao carregar dados:', e);
      }
    }

    function saveItems() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
        renderItems();
        updateStats();
      } catch (e) {
        console.error('Erro ao salvar items:', e);
        showToast('Erro ao salvar dados', 'error');
      }
    }

    function saveCustomSections() {
      try {
        localStorage.setItem(SECTIONS_KEY, JSON.stringify(customSections));
      } catch (e) {
        console.error('Erro ao salvar se√ß√µes:', e);
      }
    }

    function updateSectionSelects() {
      const select = document.getElementById('item-category');
      if (select) {
        select.innerHTML = customSections.map(s => 
          `<option value="${s.id}">${s.name}</option>`
        ).join('');
      }
    }

    function renderItems() {
      const container = document.getElementById('sections-container');
      const emptyState = document.getElementById('empty-state');
      
      const filteredItems = searchTerm 
        ? items.filter(item => item.name.toLowerCase().includes(searchTerm.toLowerCase()))
        : items;
      
      if (filteredItems.length === 0 && searchTerm) {
        container.innerHTML = `
          <div class="text-center py-16">
            <div class="text-8xl mb-4">üîç </div>
            <h3 class="text-2xl font-bold text-white mb-2">Nenhum produto encontrado</h3>
            <p class="text-white/80">Tente outro termo de busca</p>
          </div>
        `;
        emptyState.classList.add('hidden');
        return;
      }
      
      if (items.length === 0) {
        container.innerHTML = '';
        emptyState.classList.remove('hidden');
        return;
      }

      emptyState.classList.add('hidden');

      const itemsBySection = {};
      customSections.forEach(section => {
        itemsBySection[section.id] = filteredItems.filter(item => item.section === section.id);
      });

      container.innerHTML = '';
      customSections.forEach(section => {
        const sectionItems = itemsBySection[section.id] || [];
        if (sectionItems.length === 0) return;

        const sectionDiv = document.createElement('div');
        sectionDiv.className = 'section-container';
        sectionDiv.innerHTML = `
          <div class="section-header p-4 flex items-center justify-between cursor-pointer" onclick="toggleSection('${section.id}')">
            <div class="flex items-center gap-3">
              <h3 class="text-lg font-bold text-white">${section.name}</h3>
              <span class="text-white/70 text-sm font-semibold">(${sectionItems.length})</span>
            </div>
            <div class="flex items-center gap-2">
              <svg id="chevron-${section.id}" class="w-5 h-5 text-white/80 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </div>
          </div>
          <div id="section-items-${section.id}" class="p-3 space-y-2">
            ${sectionItems.map(item => createItemHTML(item)).join('')}
          </div>
        `;
        container.appendChild(sectionDiv);
      });
    }

    function createItemHTML(item) {
      const isChecked = item.checked;
      
      return `
        <div class="bg-white rounded-xl p-4 shadow hover:shadow-lg transition-all duration-300 item-enter" data-item-id="${item.id}">
          <div class="flex items-start gap-3">
            <input 
              type="checkbox" 
              ${isChecked ? 'checked' : ''}
              onchange="toggleItemCheck('${item.id}')"
              class="w-5 h-5 mt-1 rounded-md border-2 border-gray-300 cursor-pointer transition-all"
            >
            <div class="flex-1 ${isChecked ? 'opacity-50' : ''}">
              <div class="flex items-start justify-between mb-2">
                <div class="flex-1">
                  <h3 class="font-bold text-gray-800 text-lg ${isChecked ? 'line-through' : ''}">${item.name}</h3>
                  <span class="category-badge bg-indigo-100 text-indigo-700 inline-block mt-1">
                    ${item.category}
                  </span>
                </div>
                <div class="flex gap-1">
                  <button 
                    onclick="openEditModal('${item.id}')"
                    class="text-blue-500 hover:text-blue-700 hover:bg-blue-50 p-2 rounded-lg transition-colors"
                    title="Editar item"
                  >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                  </button>
                  <button 
                    onclick="openDeleteModal('${item.id}')"
                    class="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition-colors"
                  >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                  </button>
                </div>
              </div>
              <div class="flex items-center justify-between text-sm">
                <div class="text-gray-600">
                  <span class="font-semibold">Qtd:</span> ${item.quantity}x
                  <span class="ml-4 font-semibold">Pre√ßo uni:</span> R$ ${formatCurrency(item.price)}
                </div>
                <div class="font-bold text-lg ${isChecked ? 'text-gray-400' : 'text-green-600'}">
                  R$ ${formatCurrency(item.price * item.quantity)}
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function openEditModal(id) {
      const item = items.find(i => i.id === id);
      if (!item) return;

      // Preenche o modal com os dados do item
      document.getElementById('edit-item-id').value = item.id;
      document.getElementById('item-name').value = item.name;
      document.getElementById('item-price').value = formatCurrency(item.price).replace('.', ',');
      document.getElementById('item-quantity').value = item.quantity;
      document.getElementById('item-category').value = item.section;
      
      // Altera o t√≠tulo e bot√£o do modal
      document.getElementById('add-modal-title').innerHTML = '<span class="text-3xl">‚úèÔ∏è</span> Editar Item';
      document.getElementById('add-submit-btn').textContent = 'Salvar Altera√ß√µes';
      
      openAddModal();
    }

    function handleSearch() {
      searchTerm = document.getElementById('search-input').value.trim();
      const clearBtn = document.getElementById('clear-search-btn');
      
      if (searchTerm) {
        clearBtn.classList.remove('hidden');
      } else {
        clearBtn.classList.add('hidden');
      }
      
      renderItems();
    }

    function initApp() {
      loadFromStorage();
      updateSectionSelects();
      renderItems();
      updateStats();
      
      // Garantir que o campo de busca funcione
      const searchInput = document.getElementById('search-input');
      if (searchInput) {
        searchInput.addEventListener('input', handleSearch);
      }
    }

    document.addEventListener('DOMContentLoaded', initApp);

    function clearSearch() {
      document.getElementById('search-input').value = '';
      searchTerm = '';
      document.getElementById('clear-search-btn').classList.add('hidden');
      renderItems();
    }

    function toggleSection(sectionId) {
      const itemsDiv = document.getElementById(`section-items-${sectionId}`);
      const chevron = document.getElementById(`chevron-${sectionId}`);
      
      if (itemsDiv.style.display === 'none') {
        itemsDiv.style.display = 'block';
        chevron.style.transform = 'rotate(0deg)';
      } else {
        itemsDiv.style.display = 'none';
        chevron.style.transform = 'rotate(-90deg)';
      }
    }

    function toggleItemCheck(id) {
      const item = items.find(i => i.id === id);
      if (!item) return;

      item.checked = !item.checked;
      saveItems();
    }

    function updateStats() {
      const totalItems = items.length;
      const checkedItems = items.filter(i => i.checked).length;
      const totalPrice = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);

      document.getElementById('total-items').textContent = totalItems;
      document.getElementById('checked-items').textContent = checkedItems;
      document.getElementById('total-price').textContent = `R$ ${formatCurrency(totalPrice)}`;
    }

    function formatCurrency(value) {
      // Garantir que √© n√∫mero
      const num = typeof value === 'number' ? value : parseFloat(value) || 0;
      
      // Formatar com 2 casas decimais
      return num.toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    function openAddModal() {
      updateSectionSelects();
      document.getElementById('add-modal').classList.remove('hidden');
      document.getElementById('add-modal').classList.add('flex');
      document.getElementById('item-name').focus();
    }

    function closeAddModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('add-modal').classList.add('hidden');
      document.getElementById('add-modal').classList.remove('flex');
      document.getElementById('add-form').reset();
      document.getElementById('edit-item-id').value = '';
      document.getElementById('add-modal-title').innerHTML = '<span class="text-3xl">üìå</span> Adicionar Item';
      document.getElementById('add-submit-btn').textContent = 'Adicionar';
    }

    function openAddSectionModal() {
      updateCustomSectionsList();
      document.getElementById('add-section-modal').classList.remove('hidden');
      document.getElementById('add-section-modal').classList.add('flex');
      document.getElementById('section-name').focus();
    }

    function updateCustomSectionsList() {
      const listContainer = document.getElementById('custom-sections-list');
      const customItems = customSections.filter(s => !s.isDefault);
      
      if (customItems.length === 0) {
        listContainer.innerHTML = `
          <div class="text-center py-4 text-gray-400 text-sm">
            Nenhuma categoria personalizada ainda. Crie uma abaixo! üëá
          </div>
        `;
        return;
      }
      
      listContainer.innerHTML = customItems.map(section => `
        <div class="flex items-center justify-between bg-gray-50 rounded-lg p-3 hover:bg-gray-100 transition-colors">
          <span class="font-semibold text-gray-700">${section.name}</span>
          <button 
            onclick="deleteSectionFromModal('${section.id}')"
            class="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition-colors"
            title="Excluir categoria"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          </button>
        </div>
      `).join('');
    }

    function deleteSectionFromModal(sectionId) {
      const sectionItems = items.filter(item => item.section === sectionId);
      if (sectionItems.length > 0) {
        showToast('Remova todos os itens desta categoria primeiro!', 'error');
        return;
      }

      customSections = customSections.filter(s => s.id !== sectionId);
      saveCustomSections();
      updateSectionSelects();
      updateCustomSectionsList();
      renderItems();
      showToast('Categoria removida com sucesso!', 'success');
    }

    function closeAddSectionModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('add-section-modal').classList.add('hidden');
      document.getElementById('add-section-modal').classList.remove('flex');
      document.getElementById('add-section-form').reset();
    }

    function openDeleteModal(id) {
      itemToDelete = id;
      document.getElementById('delete-modal').classList.remove('hidden');
      document.getElementById('delete-modal').classList.add('flex');
    }

    function closeDeleteModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('delete-modal').classList.add('hidden');
      document.getElementById('delete-modal').classList.remove('flex');
      itemToDelete = null;
    }

    function confirmDelete() {
      if (!itemToDelete) return;

      items = items.filter(i => i.id !== itemToDelete);
      saveItems();
      showToast('Item removido com sucesso!', 'success');
      closeDeleteModal();
    }
    
    // FUN√á√ïES PARA ESVAZIAR LISTA
    function openClearAllModal() {
        if (items.length === 0) return showToast('A lista j√° est√° vazia!', 'info');
        document.getElementById('clear-all-modal').classList.remove('hidden');
        document.getElementById('clear-all-modal').classList.add('flex');
    }
    function closeClearAllModal(event) {
        if (event && event.target !== event.currentTarget) return;
        document.getElementById('clear-all-modal').classList.add('hidden');
        document.getElementById('clear-all-modal').classList.remove('flex');
    }
    function confirmClearAll() {
        items = [];
        saveItems();
        closeClearAllModal();
        showToast('Lista esvaziada com sucesso!', 'success');
    }

    function formatPrice(input) {
      let value = input.value.replace(/\D/g, '');
      if (value === '') { 
        input.value = ''; 
        return; 
      }
      
      // Garantir que temos pelo menos centavos
      value = value.padStart(3, '0');
      
      // Separar inteiro e decimal
      const integerPart = value.slice(0, -2);
      const decimalPart = value.slice(-2);
      
      // Formatar inteiro com pontos
      let formattedInteger = '';
      for (let i = integerPart.length - 1, count = 0; i >= 0; i--) {
        formattedInteger = integerPart[i] + formattedInteger;
        count++;
        if (count === 3 && i > 0) {
          formattedInteger = '.' + formattedInteger;
          count = 0;
        }
      }
      
      formattedInteger = formattedInteger.replace(/^0+/, '') || '0';
      input.value = `${formattedInteger},${decimalPart}`;
    }

    function parsePriceInput(formattedPrice) {
      // Remover tudo exceto n√∫meros, ponto e v√≠rgula
      let cleaned = formattedPrice.replace(/[^\d,\.]/g, '');
      
      // Se tiver v√≠rgula e ponto, assumir que v√≠rgula √© decimal
      if (cleaned.includes(',') && cleaned.includes('.')) {
        // Remover pontos de milhar
        cleaned = cleaned.replace(/\./g, '');
        // Substituir v√≠rgula por ponto para parseFloat
        cleaned = cleaned.replace(',', '.');
      } 
      // Se s√≥ tiver v√≠rgula, tratar como decimal
      else if (cleaned.includes(',')) {
        // Verificar se √© separador de milhar (v√≠rgula seguida de 3 d√≠gitos)
        const parts = cleaned.split(',');
        if (parts.length > 1 && parts[1].length === 3 && parts.length === 2) {
          // √â formato "1,234" (mil e duzentos e trinta e quatro)
          cleaned = cleaned.replace(',', '');
        } else {
          // √â formato "1,23" (um real e vinte e tr√™s centavos)
          cleaned = cleaned.replace(',', '.');
        }
      }
      
      const result = parseFloat(cleaned);
      return isNaN(result) ? 0 : Math.round(result * 100) / 100;
    }

    // Fun√ß√£o auxiliar para extrair pre√ßos do texto da IA
    function parsePriceFromText(priceText) {
      let text = priceText.replace('R$', '').replace('r$', '').trim();
      text = text.replace(/\./g, '').replace(',', '.');
      const result = parseFloat(text);
      return isNaN(result) ? 0 : result;
    }

    function handleAddItem(event) {
      event.preventDefault();
      
      const id = document.getElementById('edit-item-id').value;
      const name = document.getElementById('item-name').value.trim();
      const priceInput = document.getElementById('item-price').value;
      const price = parsePriceInput(priceInput);
      const quantity = parseInt(document.getElementById('item-quantity').value) || 1;
      const category = document.getElementById('item-category').value;
      const categoryObj = customSections.find(s => s.id === category);
      const categoryName = categoryObj ? categoryObj.name : category;

      // Valida√ß√£o b√°sica
      if (!name) {
        showToast('Digite o nome do produto!', 'error');
        return;
      }
      
      if (price <= 0) {
        showToast('Pre√ßo deve ser maior que zero!', 'error');
        return;
      }
      
      if (quantity <= 0) {
        showToast('Quantidade deve ser maior que zero!', 'error');
        return;
      }

      if (id) {
        // Editar item existente
        const itemIndex = items.findIndex(i => i.id === id);
        if (itemIndex !== -1) {
          items[itemIndex].name = name;
          items[itemIndex].price = price;
          items[itemIndex].quantity = quantity;
          items[itemIndex].section = category;
          items[itemIndex].category = categoryName;
          
          saveItems();
          showToast('Item atualizado com sucesso!', 'success');
        }
      } else {
        // Adicionar novo item
        const newItem = {
          id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
          section: category,
          name, price, quantity,
          category: categoryName,
          checked: false,
          createdAt: new Date().toISOString()
        };

        items.push(newItem);
        saveItems();
        showToast('Item adicionado com sucesso!', 'success');
      }
      
      closeAddModal();
    }

    function handleAddSection(event) {
      event.preventDefault();
      const name = document.getElementById('section-name').value.trim();
      const newSection = { id: 'custom_' + Date.now().toString(), name, isDefault: false };
      customSections.push(newSection);
      saveCustomSections();
      updateSectionSelects();
      updateCustomSectionsList();
      document.getElementById('section-name').value = '';
      showToast(`Categoria "${name}" criada!`, 'success');
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
    }

    function togglePrivacy() {
      document.getElementById('privacy-modal').classList.remove('hidden');
      document.getElementById('privacy-modal').classList.add('flex');
    }

    function closePrivacyModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('privacy-modal').classList.add('hidden');
      document.getElementById('privacy-modal').classList.remove('flex');
    }

    let cameraStream = null;
    let capturedImageData = null;

    function openAIModal() {
      document.getElementById('ai-modal').classList.remove('hidden');
      document.getElementById('ai-modal').classList.add('flex');
      document.getElementById('text-input-section').classList.add('hidden');
      document.getElementById('camera-input-section').classList.add('hidden');
    }

    function showTextInput() {
      document.getElementById('text-input-section').classList.remove('hidden');
      document.getElementById('camera-input-section').classList.add('hidden');
      document.getElementById('ai-text-input').focus();
    }

    function showCameraInput() {
      document.getElementById('text-input-section').classList.add('hidden');
      document.getElementById('camera-input-section').classList.remove('hidden');
    }

    // ==========================================
    // L√ìGICA DE MICROFONE INTELIGENTE (APENAS NO CAMPO DE TEXTO)
    // ==========================================
    
    let recognition = null;
    let isRecording = false;

    // Inicializa a API de Voz
    function initSpeechRecognition() {
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = 'pt-BR'; // Portugu√™s Brasil
        recognition.continuous = true; // Continua ouvindo mesmo ap√≥s pausas
        recognition.interimResults = false;

        recognition.onresult = function(event) {
          const transcript = event.results[event.results.length - 1][0].transcript;
          const textArea = document.getElementById('ai-text-input');
          
          // Adiciona o texto com quebra de linha inteligente
          const currentText = textArea.value;
          textArea.value = currentText + (currentText.length > 0 ? '\n' : '') + transcript;
          textArea.scrollTop = textArea.scrollHeight;
        };

        recognition.onerror = function(event) {
          console.error('Erro mic:', event.error);
          stopRecordingUI();
          if(event.error === 'not-allowed') {
            showToast('Permiss√£o de microfone negada.', 'error');
          }
        };

        recognition.onend = function() {
          if (isRecording) {
            // Tenta reiniciar se caiu inesperadamente
            try { recognition.start(); } catch(e) { stopRecordingUI(); }
          } else {
            stopRecordingUI();
          }
        };
      }
    }

    // Liga/Desliga grava√ß√£o
    function toggleRecording() {
      if (!recognition) initSpeechRecognition();
      
      if (!recognition) {
        showToast('Navegador sem suporte a voz.', 'error');
        return;
      }

      if (isRecording) {
        recognition.stop();
        isRecording = false;
        stopRecordingUI();
      } else {
        try {
          recognition.start();
          isRecording = true;
          startRecordingUI();
        } catch (e) {
          showToast('Erro ao iniciar microfone', 'error');
          stopRecordingUI();
        }
      }
    }

    function startRecordingUI() {
      const btn = document.getElementById('mic-toggle-btn');
      const status = document.getElementById('mic-status');
      
      if(btn) {
        btn.classList.add('mic-recording');
        // √çcone de Stop (Quadrado)
        btn.innerHTML = `<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd" /></svg>`;
      }
      if(status) status.classList.remove('hidden');
    }

    function stopRecordingUI() {
      isRecording = false;
      const btn = document.getElementById('mic-toggle-btn');
      const status = document.getElementById('mic-status');
      
      if(btn) {
        btn.classList.remove('mic-recording');
        // √çcone de Microfone
        btn.innerHTML = `<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd" /></svg>`;
      }
      if(status) status.classList.add('hidden');
    }

    // ==========================================
    // FUN√á√ÉO MELHORADA PARA PROCESSAR TEXTO DA IA
    // ==========================================
    function parseAIText(text) {
      const items = [];
      const lines = text.split(/[\n,;]/).map(line => line.trim()).filter(line => line.length > 0);
      
      lines.forEach(line => {
        // Padr√µes para detectar quantidade
        const quantityPatterns = [
          /^(\d+)\s*x\s*/i, // 2x arroz
          /(\d+)\s*un\s*/i, // 2 un arroz
          /(\d+)\s*unid\s*/i, // 2 unid arroz
          /(\d+)\s*unidades?\s*/i, // 2 unidades arroz
          /(\d+)\s*kg\s*/i, // 2 kg arroz
          /(\d+)\s*g\s*/i, // 500 g arroz
          /(\d+)\s*l\s*/i, // 2 l leite
          /(\d+)\s*ml\s*/i, // 500 ml leite
          /^(\d+)\s+/, // 2 arroz (no in√≠cio)
        ];
        
        // Padr√µes para detectar pre√ßo
        const pricePatterns = [
          /R\$\s*(\d+[\.,]?\d*)/i, // R$ 10,50
          /(\d+[\.,]?\d*)\s*reais/i, // 10,50 reais
          /(\d+[\.,]?\d*)\s*real/i, // 10,50 real
          /a\s*(\d+[\.,]?\d*)/i, // a 10,50
          /por\s*(\d+[\.,]?\d*)/i, // por 10,50
          /(\d+[\.,]?\d*)\s*r\$/i, // 10,50 r$
          /\s+(\d+[\.,]\d+)\s*$/, // arroz 10,50 (no final)
          /\s+(\d+)\s*$/, // arroz 10 (no final, inteiro)
        ];
        
        let quantity = 1;
        let price = 0;
        let productName = line;
        
        // Extrair quantidade
        for (const pattern of quantityPatterns) {
          const match = productName.match(pattern);
          if (match) {
            quantity = parseInt(match[1]);
            productName = productName.replace(match[0], '').trim();
            break;
          }
        }
        
        // Extrair pre√ßo - verificar primeiro padr√µes completos
        let priceFound = false;
        for (const pattern of pricePatterns) {
          const match = productName.match(pattern);
          if (match) {
            price = parsePriceFromText(match[1]);
            productName = productName.replace(match[0], '').trim();
            priceFound = true;
            break;
          }
        }
        
        // Se n√£o encontrou pre√ßo com padr√µes espec√≠ficos, tentar encontrar n√∫meros no texto
        if (!priceFound) {
          // Tentar encontrar o √∫ltimo n√∫mero no texto (que pode ser o pre√ßo)
          const numbers = productName.match(/\d+[\.,]?\d*/g);
          if (numbers && numbers.length > 0) {
            // Pegar o √∫ltimo n√∫mero encontrado (provavelmente o pre√ßo)
            const lastNumber = numbers[numbers.length - 1];
            const lastNumberIndex = productName.lastIndexOf(lastNumber);
            
            // Verificar se o n√∫mero est√° no final do texto ou pr√≥ximo do final
            if (lastNumberIndex > productName.length - lastNumber.length - 3) {
              price = parsePriceFromText(lastNumber);
              productName = productName.substring(0, lastNumberIndex).trim();
            }
          }
        }
        
        // Limpar texto do produto - remover palavras comuns de pre√ßo/quantidade
        productName = productName
          .replace(/\s+(de|do|da|dos|das|e|ou|com|sem)\s+$/i, '') // Remove preposi√ß√µes no final
          .replace(/^\s+|\s+$/g, '') // Remove espa√ßos no in√≠cio e fim
          .replace(/\s+/g, ' '); // Normaliza m√∫ltiplos espa√ßos
        
        // Se o nome ainda contiver n√∫meros, tentar remov√™-los (exceto se for parte do nome como "7up")
        if (productName.match(/\d/)) {
          // Verificar se o n√∫mero faz parte do nome (como "7up" ou "fanta laranja 2l")
          const hasCommonProductWithNumbers = /(7up|2l|3l|5kg|1kg|500ml|250ml)/i.test(productName);
          if (!hasCommonProductWithNumbers) {
            productName = productName.replace(/\s+\d+[\.,]?\d*\s*/g, ' ').trim();
          }
        }
        
        // Capitalizar primeira letra se o nome n√£o estiver vazio
        if (productName.length > 0) {
          productName = productName.charAt(0).toUpperCase() + productName.slice(1);
          
          // Categoria padr√£o baseada no nome
          let category = 'outros';
          const lowerName = productName.toLowerCase();
          
          if (lowerName.includes('arroz') || lowerName.includes('feij√£o') || 
              lowerName.includes('feijao') || lowerName.includes('macarr√£o') || 
              lowerName.includes('macarrao') || lowerName.includes('farinha') ||
              lowerName.includes('√≥leo') || lowerName.includes('oleo') ||
              lowerName.includes('a√ß√∫car') || lowerName.includes('acucar') ||
              lowerName.includes('caf√©') || lowerName.includes('cafe') ||
              lowerName.includes('sal') || lowerName.includes('a√ß√∫car') ||
              lowerName.includes('p√£o') || lowerName.includes('pao') ||
              lowerName.includes('manteiga') || lowerName.includes('queijo') ||
              lowerName.includes('presunto') || lowerName.includes('mortadela') ||
              lowerName.includes('carne') || lowerName.includes('frango') ||
              lowerName.includes('peixe') || lowerName.includes('ovo')) {
            category = 'alimentos';
          } else if (lowerName.includes('leite') || lowerName.includes('refri') || 
                    lowerName.includes('suco') || lowerName.includes('√°gua') ||
                    lowerName.includes('agua') || lowerName.includes('cerveja') ||
                    lowerName.includes('vinho') || lowerName.includes('refrigerante') ||
                    lowerName.includes('coca') || lowerName.includes('pepsi') ||
                    lowerName.includes('guaran√°') || lowerName.includes('guarana') ||
                    lowerName.includes('sprite') || lowerName.includes('fanta')) {
            category = 'bebidas';
          } else if (lowerName.includes('sabonete') || lowerName.includes('shampoo') || 
                    lowerName.includes('pasta') || lowerName.includes('escova') ||
                    lowerName.includes('desodorante') || lowerName.includes('papel higi√™nico') ||
                    lowerName.includes('papel higienico') || lowerName.includes('creme dental') ||
                    lowerName.includes('fio dental') || lowerName.includes('absorvente') ||
                    lowerName.includes('protetor') || lowerName.includes('hidratante')) {
            category = 'higiene';
          } else if (lowerName.includes('detergente') || lowerName.includes('sab√£o') || 
                    lowerName.includes('sabao') || lowerName.includes('esponja') || 
                    lowerName.includes('desinfetante') || lowerName.includes('√°lcool') ||
                    lowerName.includes('alcool') || lowerName.includes('lustra m√≥veis') ||
                    lowerName.includes('lustra moveis') || lowerName.includes('amaciante') ||
                    lowerName.includes('√°gua sanit√°ria') || lowerName.includes('agua sanitaria')) {
            category = 'limpeza';
          }
          
          items.push({
            name: productName,
            price: price,
            quantity: quantity,
            category: category
          });
        }
      });
      
      return items;
    }

    function closeAIModal(event) {
      if (event && event.target !== event.currentTarget) return;
      
      // Para o microfone se estiver gravando
      if (isRecording && recognition) {
        recognition.stop();
        isRecording = false;
        stopRecordingUI();
      }

      stopCamera();
      document.getElementById('ai-modal').classList.add('hidden');
      document.getElementById('ai-modal').classList.remove('flex');
      document.getElementById('ai-text-input').value = '';
      document.getElementById('text-input-section').classList.add('hidden');
      document.getElementById('camera-input-section').classList.add('hidden');
      capturedImageData = null;
    }

    async function startCamera() {
      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        const video = document.getElementById('camera-stream');
        video.srcObject = cameraStream;
        video.classList.remove('hidden');
        document.getElementById('start-camera-btn').classList.add('hidden');
        document.getElementById('camera-controls').classList.remove('hidden');
        showToast('C√¢mera ativada!', 'success');
      } catch (error) {
        showToast('N√£o foi poss√≠vel acessar a c√¢mera', 'error');
      }
    }

    function stopCamera() {
      if (cameraStream) { cameraStream.getTracks().forEach(track => track.stop()); cameraStream = null; }
      const video = document.getElementById('camera-stream');
      if (video) video.classList.add('hidden');
      const startBtn = document.getElementById('start-camera-btn');
      if (startBtn) startBtn.classList.remove('hidden');
      const controls = document.getElementById('camera-controls');
      if (controls) controls.classList.add('hidden');
    }

    function capturePhoto() {
      const video = document.getElementById('camera-stream'), canvas = document.getElementById('photo-canvas'), context = canvas.getContext('2d');
      
      // Limita o tamanho da imagem
      const MAX_WIDTH = 800;
      const scale = MAX_WIDTH / video.videoWidth;
      canvas.width = MAX_WIDTH;
      canvas.height = video.videoHeight * scale;

      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      // Compress√£o JPEG
      capturedImageData = canvas.toDataURL('image/jpeg', 0.7);
      
      document.getElementById('captured-photo-img').src = capturedImageData;
      document.getElementById('captured-photo-preview').classList.remove('hidden');
      video.classList.add('hidden');
      document.getElementById('camera-controls').classList.add('hidden');
      document.getElementById('photo-actions').classList.remove('hidden');
      stopCamera();
      showToast('Foto capturada!', 'success');
    }

    function retakePhoto() { capturedImageData = null; document.getElementById('captured-photo-preview').classList.add('hidden'); document.getElementById('photo-actions').classList.add('hidden'); startCamera(); }
    function clearPhoto() { capturedImageData = null; document.getElementById('captured-photo-preview').classList.add('hidden'); document.getElementById('photo-actions').classList.add('hidden'); document.getElementById('start-camera-btn').classList.remove('hidden'); }

    // Fun√ß√£o principal para processar IA
    async function handleAISubmit() {
      const textInput = document.getElementById('ai-text-input').value.trim();
      if (!textInput && !capturedImageData) { showToast('Digite um texto OU tire uma foto!', 'error'); return; }

      const submitBtn = capturedImageData ? document.getElementById('camera-submit-btn') : document.getElementById('text-submit-btn');
      if (!submitBtn) return;
      const originalContent = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<div class="loading-spinner mx-auto"></div>';

      try {
        showToast('Processando...', 'info');
        
        // Simula um delay de processamento
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        let extractedItems = [];
        
        if (textInput) {
          // Processa texto usando a nova fun√ß√£o parseAIText
          extractedItems = parseAIText(textInput);
          
          // Se n√£o conseguiu extrair itens, cria um item com o texto completo
          if (extractedItems.length === 0) {
            extractedItems.push({
              name: textInput,
              price: 0,
              quantity: 1,
              category: 'outros'
            });
          }
          
          // Mostrar no console para debug
          console.log('Itens extra√≠dos:', extractedItems);
        } else if (capturedImageData) {
          // Para imagem, simula itens comuns com pre√ßos e quantidades
          extractedItems = [
            { name: 'Arroz 5kg', price: 25.90, quantity: 1, category: 'alimentos' },
            { name: 'Feij√£o Carioca 1kg', price: 8.50, quantity: 1, category: 'alimentos' },
            { name: '√ìleo de Soja 900ml', price: 9.99, quantity: 1, category: 'alimentos' },
            { name: 'Leite Integral 1L', price: 6.99, quantity: 2, category: 'bebidas' },
            { name: 'Sab√£o em P√≥ 1kg', price: 12.90, quantity: 1, category: 'limpeza' }
          ];
        }
        
        // Adiciona os itens extra√≠dos √† lista
        extractedItems.forEach(item => {
          const categoryObj = customSections.find(s => s.id === item.category);
          const validSection = categoryObj ? item.category : 'outros';
          const validCategoryName = categoryObj ? categoryObj.name : 'üì¶ Outros';

          const newItem = {
            id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
            section: validSection,
            name: item.name,
            price: parseFloat(item.price) || 0,
            quantity: parseInt(item.quantity) || 1,
            category: validCategoryName,
            checked: false,
            createdAt: new Date().toISOString()
          };
          items.push(newItem);
        });

        saveItems();
        showToast(`${extractedItems.length} itens adicionados! ü§ñ`, 'success');
        closeAIModal();
      } catch (error) {
        showToast('Erro ao processar: ' + error.message, 'error');
        console.error("Erro:", error);
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalContent;
      }
    }
  </script>
 </body>
</html>